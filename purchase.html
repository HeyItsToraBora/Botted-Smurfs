<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Receipt</title>
    <link rel="stylesheet" href="/assets/styles.css">
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <style>
        body {
            background: #151c28;
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .receipt-container {
            max-width: 600px;
            margin: 40px auto;
            background: #1b2332;
            border-radius: 12px;
            box-shadow: 0 4px 24px #000a;
            padding: 32px 32px 24px 32px;
        }
        .receipt-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 24px;
        }
        .receipt-section {
            margin-bottom: 18px;
        }
        .receipt-label {
            font-weight: 500;
            margin-bottom: 6px;
        }
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 18px;
        }
        .receipt-table th, .receipt-table td {
            padding: 8px 6px;
            text-align: left;
        }
        .receipt-table th {
            background: #232b3d;
            font-weight: 600;
        }
        .receipt-table td {
            background: #232b3d;
        }
        .receipt-summary {
            margin-top: 18px;
            font-size: 1.1rem;
        }
        .receipt-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .receipt-summary-total {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .payment-info {
            background: #232b3d;
            border-radius: 8px;
            padding: 18px 24px;
            margin-top: 24px;
        }
        .payment-note {
            color: #ffb300;
            margin-top: 12px;
            font-size: 1rem;
        }
        .timer {
            margin-top: 24px;
            font-size: 1.1rem;
            color: #7ee787;
            font-weight: 600;
        }
        .back-home-btn {
            display: inline-block;
            margin-top: 32px;
            background: #232b3d;
            color: #fff;
            padding: 10px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 1.1rem;
            transition: background 0.2s;
        }
        .back-home-btn:hover {
            background: #1b2332;
            color: #7ee787;
        }
    </style>
</head>
<body>
    <div class="receipt-container">
        <div class="receipt-title">Purchase Receipt</div>
        <div id="receiptDetails">
            <!-- Receipt details will be loaded here -->
        </div>
        <button id="paidBtn" style="margin-top:18px;display:none;background:#10b981;color:#fff;padding:10px 24px;border:none;border-radius:6px;font-size:1.1rem;font-weight:500;cursor:pointer;">Paid</button>
        <div class="timer" id="timer"></div>
        <div class="payment-note">
            Please send the <b>exact amount</b> to <b>any</b> of the addresses above <b>after fees</b>. Your order will be processed after payment is confirmed.<br>
            <b>Note:</b> If payment is not received within 2 hours, your order will be cancelled.
        </div>
        <a href="/home.html" class="back-home-btn" id="backHomeBtn" style="display:none;">Back to Home</a>
    </div>
    <script>
    // Helper to get query param
    function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }
    const purchaseId = getQueryParam('purchaseId');
    if (!purchaseId) {
        document.getElementById('receiptDetails').innerHTML = '<span style="color:#ff5c5c;">Invalid purchase link.</span>';
        document.getElementById('timer').style.display = 'none';
    } else {
        fetch(`/purchase/${purchaseId}`)
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    document.getElementById('receiptDetails').innerHTML = '<span style="color:#ff5c5c;">Purchase not found.</span>';
                    document.getElementById('timer').style.display = 'none';
                    return;
                }
                const p = data.purchase;
                let html = '';
                html += `<div class='receipt-section'><span class='receipt-label'>Purchase ID:</span> #${p.id}</div>`;
                html += `<div class='receipt-section'><span class='receipt-label'>Date:</span> ${new Date(p.created_at).toLocaleString()}</div>`;
                html += `<div class='receipt-section'><span class='receipt-label'>User:</span> ${p.user_email}</div>`;
                html += `<div class='receipt-section'><span class='receipt-label'>Status:</span> ${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</div>`;
                html += `<div class='receipt-section'><span class='receipt-label'>Payment Confirmation:</span> <span id='paymentConfirmationStatus'>${p.payment_confirmation.charAt(0).toUpperCase() + p.payment_confirmation.slice(1)}</span></div>`;
                html += `<div class='receipt-section'><span class='receipt-label'>Items:</span>`;
                html += `<table class='receipt-table'><thead><tr><th>Offer</th><th>Server</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th></tr></thead><tbody>`;
                for (const item of p.items) {
                    html += `<tr><td>${item.offer_name}</td><td>${item.server_name}</td><td>${item.quantity}</td><td>$${item.price_per_account.toFixed(2)}</td><td>$${(item.price_per_account * item.quantity).toFixed(2)}</td></tr>`;
                }
                html += `</tbody></table></div>`;
                html += `<div class='receipt-summary'>`;
                html += `<div class='receipt-summary-row'><span>Total before coupon:</span><span>$${p.total_before_coupon.toFixed(2)}</span></div>`;
                if (p.coupon_code) {
                    html += `<div class='receipt-summary-row'><span>Coupon (${p.coupon_code}, ${p.coupon_percent}%):</span><span>-$${(p.total_before_coupon - p.subtotal_after_coupon).toFixed(2)}</span></div>`;
                }
                html += `<div class='receipt-summary-row receipt-summary-total'><span>Total to Pay:</span><span>$${p.subtotal_after_coupon.toFixed(2)}</span></div>`;
                html += `</div>`;
                html += `<div class='payment-info'><div class='receipt-label'>Payment Methods (choose any):</div>`;
                for (const net of p.payment_networks) {
                    html += `<div style='margin-bottom:8px;'><b>${net.network}:</b> <span style='word-break:break-all;font-family:monospace;font-size:1.1em;'>${net.address}</span></div>`;
                }
                html += `</div>`;
                document.getElementById('receiptDetails').innerHTML = html;
                // Show Paid button if not already confirmed
                if (p.payment_confirmation === 'unconfirmed') {
                    document.getElementById('paidBtn').style.display = 'inline-block';
                }
            });
    }
    // 2-hour timer
    let timerSeconds = 2 * 60 * 60;
    function updateTimer() {
        if (timerSeconds <= 0) {
            document.getElementById('timer').textContent = 'Time expired. Redirecting to home...';
            document.getElementById('backHomeBtn').style.display = 'inline-block';
            setTimeout(() => {
                window.location.href = '/home.html';
            }, 4000);
            // Optionally clear cart in localStorage/session here if needed
            return;
        }
        const h = Math.floor(timerSeconds / 3600);
        const m = Math.floor((timerSeconds % 3600) / 60);
        const s = timerSeconds % 60;
        document.getElementById('timer').textContent = `Time left to pay: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        timerSeconds--;
        setTimeout(updateTimer, 1000);
    }
    if (purchaseId) updateTimer();
    // Paid button logic
    document.getElementById('paidBtn').addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = 'Processing...';
        try {
            const res = await fetch(`/purchase/${purchaseId}/confirm-payment`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ payment_confirmation: 'confirmed' })
            });
            if (res.ok) {
                window.location.href = '/home.html';
            } else {
                this.disabled = false;
                this.textContent = 'Paid';
                alert('Error confirming payment. Please try again.');
            }
        } catch {
            this.disabled = false;
            this.textContent = 'Paid';
            alert('Error confirming payment. Please try again.');
        }
    });
    </script>
</body>
</html> 